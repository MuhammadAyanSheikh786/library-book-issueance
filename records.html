<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FDC Library ‚Äî Records</title>
  <style>
    :root{
      --bg1:#081229; --bg2:#14223b; --glass:rgba(255,255,255,0.03); --text:#e9f2ff;
      --accent1:#ff0057; --accent2:#7303c0; --accent3:#00c9ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;min-height:100vh;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);}

    header{background:linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent3));padding:14px 18px;text-align:center;font-weight:700}
    .nav{display:flex;justify-content:center;gap:8px;padding:10px;background:rgba(255,255,255,0.03)}
    .nav a{color:#fff;text-decoration:none;padding:8px 10px;border-radius:8px}
    .wrap{max-width:1100px;margin:18px auto;padding:0 16px;display:flex;flex-direction:column;gap:14px}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input.search{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text)}

    .accordion{background:var(--glass);border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,0.04)}
    .class-header{display:flex;justify-content:space-between;align-items:center;padding:10px;cursor:pointer;border-radius:8px}
    .class-header h3{margin:0;font-size:16px}
    .class-content{padding:8px 10px}

    .record{background:rgba(255,255,255,0.02);border-radius:8px;padding:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    .rec-left{flex:1}
    .muted{color:rgba(255,255,255,0.7);font-size:13px}
    .rec-actions{display:flex;gap:8px}
    .btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn-return{background:#22c55e;color:#01210a}
    .btn-delete{background:#ef4444;color:#fff}
    .notice{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)}

    @media(max-width:720px){
      .record{flex-direction:column;align-items:flex-start}
      .rec-actions{width:100%}
    }
  </style>
</head>
<body>
  <header>üìö FDC Library ‚Äî Records</header>
  <div class="nav">
    <a href="index.html">Dashboard</a>
    <a href="records.html">Records</a>
    <a href="login.html">Librarian Login</a>
  </div>

  <div class="wrap">
    <div class="controls">
      <input id="q" class="search" placeholder="Search by student, roll, book, or class... (type and press Enter)">
      <button class="btn" onclick="render()">Search</button>
      <button class="btn" onclick="clearSearch()">Clear</button>
    </div>

    <div id="recordsContainer"></div>
  </div>

<script>
  const KEY = 'fdcApplicants';
  const PIN = '@fdc@';
  function load(){ return JSON.parse(localStorage.getItem(KEY) || '[]'); }
  function save(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
  function isAuth(){ return sessionStorage.getItem('fdcAuth') === 'true'; }

  // calc days since issueDate (ms)
  function daysSince(ms){ const d = Math.floor((Date.now() - ms) / (1000*60*60*24)); return d; }

  // render class-wise
  function render(){
    const q = (document.getElementById('q').value || '').toLowerCase().trim();
    const container = document.getElementById('recordsContainer');
    container.innerHTML = '';
    const arr = load();

    // group by className (1..12 or strings)
    const grouped = {};
    arr.forEach(r=>{
      const cls = r.className || r.class || 'Unspecified';
      if(!grouped[cls]) grouped[cls] = [];
      grouped[cls].push(r);
    });

    const classes = Object.keys(grouped).sort((a,b)=> {
      const na = parseInt(a), nb = parseInt(b);
      if(!isNaN(na) && !isNaN(nb)) return na - nb;
      return a.localeCompare(b);
    });

    if (classes.length === 0) {
      container.innerHTML = '<div class="notice">No records found.</div>';
      return;
    }

    classes.forEach(cls=>{
      // filter by search
      let items = grouped[cls].filter(r=>{
        if(!q) return true;
        return (r.studentName||'').toLowerCase().includes(q) ||
               (r.rollNo||'').toLowerCase().includes(q) ||
               (r.bookName||'').toLowerCase().includes(q) ||
               (String(r.className||'')).toLowerCase().includes(q);
      });

      // skip empty after filter
      if(items.length === 0) return;

      const acc = document.createElement('div');
      acc.className = 'accordion';

      const head = document.createElement('div');
      head.className = 'class-header';
      head.innerHTML = `<h3>Class ${cls}</h3><div class="muted">(${items.length})</div>`;
      head.onclick = () => {
        const c = acc.querySelector('.class-content');
        c.style.display = c.style.display === 'block' ? 'none' : 'block';
      };

      const content = document.createElement('div');
      content.className = 'class-content';
      content.style.display = 'none';

      items.sort((a,b)=> b.issueDate - a.issueDate).forEach(r=>{
        const rec = document.createElement('div');
        rec.className = 'record';
        const left = document.createElement('div'); left.className='rec-left';
        const days = daysSince(r.issueDate || 0);
        left.innerHTML = `<strong>${r.studentName}</strong> <div class="muted">Roll: ${r.rollNo || '-'} ¬∑ Phone: ${r.phone || '-'} ¬∑ Book: ${r.bookName || '-'} </div>
                          <div class="muted">Issued: ${new Date(r.issueDate).toLocaleDateString()} ¬∑ Days: ${days} ¬∑ Status: ${r.returned ? 'Returned ‚úÖ' : 'Pending ‚è≥'}</div>`;

        const actions = document.createElement('div'); actions.className='rec-actions';

        // Return / Delete buttons visible only for logged-in librarian
        if (isAuth()) {
          if (!r.returned) {
            const btnReturn = document.createElement('button'); btnReturn.className='btn btn-return'; btnReturn.textContent='Mark Returned';
            btnReturn.onclick = () => doReturn(r.id);
            actions.appendChild(btnReturn);
          }
          const btnDelete = document.createElement('button'); btnDelete.className='btn btn-delete'; btnDelete.textContent='Delete';
          btnDelete.onclick = () => doDelete(r.id);
          actions.appendChild(btnDelete);
        }

        rec.appendChild(left);
        if(isAuth()) rec.appendChild(actions);
        content.appendChild(rec);
      });

      acc.appendChild(head);
      acc.appendChild(content);
      container.appendChild(acc);
    });
  }

  // actions require PIN confirmation
  function askPin(){
    const pin = prompt('Enter librarian PIN to confirm:');
    return pin === PIN;
  }

  function doReturn(id){
    if(!askPin()){ alert('Wrong PIN'); return; }
    const arr = load();
    const idx = arr.findIndex(x=>x.id === id);
    if(idx === -1) return alert('Record not found');
    arr[idx].returned = true;
    save(arr); render(); alert('Marked returned');
  }

  function doDelete(id){
    if(!askPin()){ alert('Wrong PIN'); return; }
    if(!confirm('Delete this record permanently?')) return;
    let arr = load();
    arr = arr.filter(x=>x.id !== id);
    save(arr); render(); alert('Deleted');
  }

  function clearSearch(){ document.getElementById('q').value=''; render(); }

  // on load: if not logged in, user can still view records (read-only).
  // If been logged-in in this tab, action buttons will be visible.
  document.addEventListener('DOMContentLoaded', ()=>{ render(); });
</script>
</body>
</html>
